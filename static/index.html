<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Betradar UOF ç›‘æ§é¢æ¿</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      color: #333;
      font-size: 24px;
    }

    .status {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .status.connected {
      background: #4caf50;
      color: white;
    }

    .status.disconnected {
      background: #f44336;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .panel h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #2196f3;
      padding-bottom: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    button:hover {
      background: #1976d2;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.danger {
      background: #f44336;
    }

    button.danger:hover {
      background: #d32f2f;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 5px;
      word-wrap: break-word;
    }

    .log-entry.info {
      color: #4fc3f7;
    }

    .log-entry.success {
      color: #81c784;
    }

    .log-entry.warning {
      color: #ffb74d;
    }

    .log-entry.error {
      color: #e57373;
    }

    .log-entry .timestamp {
      color: #888;
      margin-right: 10px;
    }

    .log-entry .type {
      color: #ce93d8;
      font-weight: bold;
      margin-right: 10px;
    }

    .events-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .event-item {
      background: #f9f9f9;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      border-left: 4px solid #2196f3;
    }

    .event-id {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .event-meta {
      font-size: 12px;
      color: #666;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .xml-preview {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸ¯ Betradar UOF ç›‘æ§é¢æ¿</h1>
      <span class="status disconnected" id="status">æœªè¿æ¥</span>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
        <div class="stat-value" id="totalMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è·Ÿè¸ªèµ›äº‹</div>
        <div class="stat-value" id="totalEvents">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">èµ”ç‡å˜åŒ–</div>
        <div class="stat-value" id="oddsChanges">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æŠ•æ³¨åœæ­¢</div>
        <div class="stat-value" id="betStops">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æŠ•æ³¨ç»“ç®—</div>
        <div class="stat-value" id="betSettlements">0</div>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="panel">
      <h2>æ§åˆ¶é¢æ¿</h2>
      <div class="controls">
        <button id="connectBtn">è¿æ¥</button>
        <button id="disconnectBtn" disabled>æ–­å¼€</button>
        <button id="refreshStatsBtn">åˆ·æ–°ç»Ÿè®¡</button>
        <button id="loadEventsBtn">åŠ è½½èµ›äº‹</button>
        <button id="clearLogBtn" class="danger">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <div class="filters">
        <input type="text" class="filter-input" id="eventIdFilter" placeholder="è¿‡æ»¤èµ›äº‹ID (ä¾‹å¦‚: sr:match:12345)">
        <button id="subscribeBtn">è®¢é˜…èµ›äº‹</button>
        <button id="unsubscribeBtn">å–æ¶ˆè®¢é˜…</button>
      </div>
    </div>

    <!-- è·Ÿè¸ªçš„èµ›äº‹ -->
    <div class="panel">
      <h2>è·Ÿè¸ªçš„èµ›äº‹</h2>
      <div class="events-list" id="eventsList">
        <p style="color: #999;">æš‚æ— è·Ÿè¸ªçš„èµ›äº‹</p>
      </div>
    </div>

    <!-- å®æ—¶æ¶ˆæ¯æ—¥å¿— -->
    <div class="panel">
      <h2>å®æ—¶æ¶ˆæ¯æ—¥å¿—</h2>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script src="/uof-client.js"></script>
  <script>
    // åˆ›å»ºå®¢æˆ·ç«¯
    const client = window.createUOFClient({
      autoReconnect: true
    });

    // DOMå…ƒç´ 
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const refreshStatsBtn = document.getElementById('refreshStatsBtn');
    const loadEventsBtn = document.getElementById('loadEventsBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const unsubscribeBtn = document.getElementById('unsubscribeBtn');
    const eventIdFilter = document.getElementById('eventIdFilter');
    const logContainer = document.getElementById('logContainer');
    const eventsList = document.getElementById('eventsList');

    // ç»Ÿè®¡æ•°æ®
    let stats = {
      totalMessages: 0,
      oddsChanges: 0,
      betStops: 0,
      betSettlements: 0
    };

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      document.getElementById('totalMessages').textContent = stats.totalMessages;
      document.getElementById('oddsChanges').textContent = stats.oddsChanges;
      document.getElementById('betStops').textContent = stats.betStops;
      document.getElementById('betSettlements').textContent = stats.betSettlements;
    }

    // åˆ·æ–°ç»Ÿè®¡
    async function refreshStats() {
      try {
        const data = await client.getStats();
        document.getElementById('totalMessages').textContent = data.total_messages || 0;
        document.getElementById('totalEvents').textContent = data.total_events || 0;
        document.getElementById('oddsChanges').textContent = data.odds_changes || 0;
        document.getElementById('betStops').textContent = data.bet_stops || 0;
        document.getElementById('betSettlements').textContent = data.bet_settlements || 0;
      } catch (error) {
        log(`åˆ·æ–°ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åŠ è½½èµ›äº‹åˆ—è¡¨
    async function loadEvents() {
      try {
        const data = await client.getTrackedEvents();
        const events = data.events || [];

        if (events.length === 0) {
          eventsList.innerHTML = '<p style="color: #999;">æš‚æ— è·Ÿè¸ªçš„èµ›äº‹</p>';
          return;
        }

        eventsList.innerHTML = '';
        events.forEach(event => {
          const item = document.createElement('div');
          item.className = 'event-item';
          item.innerHTML = `
            <div class="event-id">${event.event_id}</div>
            <div class="event-meta">
              æ¶ˆæ¯æ•°: ${event.message_count} | 
              æœ€åæ›´æ–°: ${new Date(event.last_message_at).toLocaleString()}
            </div>
          `;
          eventsList.appendChild(item);
        });

        log(`åŠ è½½äº† ${events.length} ä¸ªè·Ÿè¸ªçš„èµ›äº‹`, 'success');
      } catch (error) {
        log(`åŠ è½½èµ›äº‹å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // äº‹ä»¶ç›‘å¬
    client.on('connected', () => {
      statusEl.textContent = 'å·²è¿æ¥';
      statusEl.className = 'status connected';
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
      log('âœ“ å·²è¿æ¥åˆ°UOFæœåŠ¡', 'success');
      refreshStats();
    });

    client.on('disconnected', () => {
      statusEl.textContent = 'æœªè¿æ¥';
      statusEl.className = 'status disconnected';
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      log('âœ— å·²æ–­å¼€è¿æ¥', 'warning');
    });

    client.on('message', (msg) => {
      stats.totalMessages++;
      updateStats();

      const typeSpan = `<span class="type">[${msg.message_type || msg.type}]</span>`;
      const eventInfo = msg.event_id ? ` Event: ${msg.event_id}` : '';
      log(`${typeSpan}${eventInfo}`, 'info');

      // æ˜¾ç¤ºXMLé¢„è§ˆ(å‰200å­—ç¬¦)
      if (msg.xml) {
        const xmlPreview = msg.xml.substring(0, 200) + (msg.xml.length > 200 ? '...' : '');
        log(`<div class="xml-preview">${escapeHtml(xmlPreview)}</div>`, 'info');
      }
    });

    client.on('odds_change', (msg) => {
      stats.oddsChanges++;
      updateStats();
      log(`<span class="type">[èµ”ç‡å˜åŒ–]</span> ${msg.event_id}`, 'success');
    });

    client.on('bet_stop', (msg) => {
      stats.betStops++;
      updateStats();
      log(`<span class="type">[æŠ•æ³¨åœæ­¢]</span> ${msg.event_id}`, 'warning');
    });

    client.on('bet_settlement', (msg) => {
      stats.betSettlements++;
      updateStats();
      log(`<span class="type">[æŠ•æ³¨ç»“ç®—]</span> ${msg.event_id}`, 'success');
    });

    client.on('error', (error) => {
      log(`é”™è¯¯: ${error.message || error}`, 'error');
    });

    // æŒ‰é’®äº‹ä»¶
    connectBtn.addEventListener('click', () => {
      client.connect();
    });

    disconnectBtn.addEventListener('click', () => {
      client.disconnect();
    });

    refreshStatsBtn.addEventListener('click', refreshStats);
    loadEventsBtn.addEventListener('click', loadEvents);
    clearLogBtn.addEventListener('click', () => {
      logContainer.innerHTML = '';
    });

    subscribeBtn.addEventListener('click', () => {
      const eventId = eventIdFilter.value.trim();
      if (eventId) {
        client.subscribe([], [eventId]);
        log(`è®¢é˜…èµ›äº‹: ${eventId}`, 'success');
      }
    });

    unsubscribeBtn.addEventListener('click', () => {
      client.unsubscribe();
      log('å·²å–æ¶ˆæ‰€æœ‰è®¢é˜…', 'info');
    });

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // è‡ªåŠ¨è¿æ¥
    log('é¡µé¢åŠ è½½å®Œæˆ,ç‚¹å‡»"è¿æ¥"æŒ‰é’®å¼€å§‹', 'info');
    
    // è‡ªåŠ¨è¿æ¥(å¯é€‰)
    // client.connect();
  </script>
</body>
</html>

