# 飞书(Lark)集成与监控功能交付报告

## 任务概述

本次任务的目标是为 Betradar UOF 服务添加飞书(Lark)机器人通知功能,以实现主动监控、定期报告和关键事件告警。所有需求均已完成,并通过了本地测试和 Railway 部署验证。

## 完成功能

我们成功实现了以下核心功能:

| 功能 | 描述 | 触发方式 |
| :--- | :--- | :--- |
| **服务启动通知** | 服务启动时发送通知,确认部署成功。 | 自动 |
| **消息统计报告** | 每5分钟发送一次消息统计,按类型分组。 | 自动 (周期性) |
| **比赛订阅监控** | 每小时检查一次已订阅的比赛,并发送报告。 | 自动 (周期性) |
| **手动监控** | 提供 API 接口,可随时手动触发比赛订阅检查。 | 手动 (API) |
| **恢复通知** | 在数据恢复(Recovery)成功或失败时发送通知。 | 自动 (事件驱动) |
| **错误告警** | 在服务发生关键错误时(如 AMQP 消费者或 Web 服务器崩溃)发送通知。 | 自动 (事件驱动) |

这些功能共同构成了一个强大的监控体系,能够让您实时了解服务的健康状况、消息处理量以及关键的 `odds_change` 消息订阅状态。

## 交付成果

### 1. 源代码 (已更新)

所有与飞书集成相关的代码均已提交到您的 GitHub 仓库:

- **仓库地址**: [https://github.com/gdszyy/betradar-uof-service](https://github.com/gdszyy/betradar-uof-service)

最新的提交包含了所有新功能和文档更新。

### 2. 详细文档

我们为您准备了详细的飞书集成文档,包含了功能介绍、配置方法、通知示例和故障排除指南。

- **文档路径**: `docs/FEISHU-INTEGRATION.md`

您可以在 GitHub 仓库中直接查看该文件,或在本次交付的附件中找到。

### 3. 主文档更新

`README.md` 文件也已更新,添加了飞书集成的简要说明和相关配置项,方便新用户快速上手。

## 如何使用

### 1. 配置 Webhook

为了启用飞书通知,您需要在 Railway 项目的环境变量中添加 `LARK_WEBHOOK_URL`。具体步骤如下:

1. 在飞书群组中添加一个“自定义机器人”。
2. 复制生成的 Webhook 地址。
3. 在 Railway 项目的 “Variables” 页面,添加一个名为 `LARK_WEBHOOK_URL` 的新变量,值为您复制的 Webhook 地址。

Railway 会自动使用新的环境变量重新部署服务,之后您就会在飞书群组中收到通知。

### 2. 手动触发监控

如果您想立即检查比赛订阅状态,可以执行以下命令:

```bash
curl -X POST https://betradar-uof-service-copy-production.up.railway.app/api/monitor/trigger
```

执行后,最新的监控报告将立即发送到您的飞书群组。

## 总结

通过本次迭代,您的 UOF 服务不仅具备了强大的数据处理能力,还拥有了完善的主动监控和通知机制。这对于保障服务的稳定运行和及时发现潜在问题(如没有订阅比赛导致收不到赔率数据)至关重要。

感谢您的信任,我们很高兴能为您完成这次功能开发。如果您有任何问题,请随时提出。

